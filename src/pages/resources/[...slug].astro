---
import { getCollection } from "astro:content";
import MainLayout from "../../layouts/MainLayout.astro";
import { marked } from "marked";

export const prerender = true;

export async function getStaticPaths() {
    const resources = await getCollection("resources");
    return resources.map((resource) => {
        // Handle case where id has .md extension
        const slug = (resource as any).slug || resource.id.replace(/\.md$/, "");
        return {
            params: { slug },
            props: { resource },
        };
    });
}

const { resource } = Astro.props;
const embeds = resource.data.embeds || [];
const headings = embeds
    .filter((e: any) => e.title)
    .map((e: any) => ({
        depth: 2,
        slug: e.title.toLowerCase().replace(/[^\w]+/g, "-"),
        text: e.title,
    }));
---

<MainLayout title={`${resource.data.title} | SITE USTP`}>
    <div class="bg-white min-h-screen py-10 md:py-16 relative">
        <div class="max-w-[80rem] mx-auto px-4 sm:px-6 lg:px-8">
            <div
                class="flex flex-wrap items-center gap-2 text-xs sm:text-sm text-gray-500 mb-6 sm:mb-8 font-medium uppercase tracking-wider"
            >
                <a href="/" class="hover:text-blue-600 transition-colors"
                    >Home</a
                >
                <span>&rsaquo;</span>
                <a
                    href="/resources"
                    class="hover:text-blue-600 transition-colors">Resources</a
                >
                <span>&rsaquo;</span>
                <span
                    class="text-gray-900 truncate"
                    title={resource.data.title}
                >
                    {resource.data.title}
                </span>
            </div>

            <div class="flex flex-col lg:flex-row gap-12 items-start">
                <!-- Main Content -->
                <article class="flex-1 max-w-[65ch] w-full order-2 lg:order-1">
                    <header class="mb-10 lg:mb-16">
                        <div class="flex items-center gap-3 mb-6">
                            <span
                                class="text-sm font-semibold text-gray-500 uppercase tracking-wide"
                            >
                                {resource.data.category} Overview
                            </span>
                        </div>
                        <h1
                            class="text-3xl sm:text-4xl lg:text-[2.75rem] font-bold text-gray-900 leading-[1.15] tracking-tight mb-6"
                        >
                            {resource.data.title}
                        </h1>

                        <p class="text-lg text-gray-600 leading-relaxed mb-8">
                            {resource.data.description}
                        </p>

                        {
                            resource.data.heroImage && (
                                <div class="mb-10 w-full overflow-hidden rounded-xl border border-gray-100 shadow-sm">
                                    <img
                                        src={resource.data.heroImage}
                                        alt={resource.data.title}
                                        class="w-full h-auto object-cover max-h-[400px]"
                                    />
                                </div>
                            )
                        }

                        <!-- Metadata / Date -->
                        {
                            resource.data.date && (
                                <div class="flex items-center text-xs text-gray-500 mb-8 border-b border-gray-100 pb-4">
                                    <span>
                                        Published:{" "}
                                        {new Date(
                                            resource.data.date,
                                        ).toLocaleDateString("en-US", {
                                            year: "numeric",
                                            month: "long",
                                            day: "numeric",
                                        })}
                                    </span>
                                </div>
                            )
                        }
                    </header>

                    <div
                        class="prose prose-lg text-gray-700 custom-light-prose max-w-none"
                    >
                        {
                            embeds.map((embed: any) => (
                                <div
                                    class="embed-section mb-12 scroll-mt-28 md:scroll-mt-32"
                                    id={
                                        embed.title
                                            ? embed.title
                                                  .toLowerCase()
                                                  .replace(/[^\w]+/g, "-")
                                            : ""
                                    }
                                >
                                    {embed.title && (
                                        <h2 class="text-2xl font-bold mb-4">
                                            {embed.title}
                                        </h2>
                                    )}
                                    {embed.description && (
                                        <div
                                            class="embed-body"
                                            set:html={marked.parse(
                                                embed.description,
                                            )}
                                        />
                                    )}
                                </div>
                            ))
                        }
                        {
                            embeds.length === 0 && (
                                <p class="text-gray-500 italic">
                                    No content sections available.
                                </p>
                            )
                        }
                    </div>
                </article>

                <!-- Right Sidebar (Table of Contents & Quick Links) -->
                <aside
                    class="w-full lg:w-72 flex-shrink-0 order-1 lg:order-2 lg:sticky lg:top-24"
                >
                    <div
                        class="bg-[#fbfcff] rounded-lg p-6 border border-[#e5e7eb] relative"
                    >
                        <h3
                            class="text-xs font-bold text-gray-900 uppercase tracking-widest mb-4"
                        >
                            On this page
                        </h3>

                        <nav class="flex flex-col space-y-2.5">
                            {
                                headings && headings.length > 0 ? (
                                    headings.map((heading: any) => (
                                        <a
                                            href={`#${heading.slug}`}
                                            class={`text-sm font-medium text-gray-600 hover:text-blue-600 transition-colors block
                                        ${heading.depth === 2 ? "text-gray-900" : ""}
                                        ${heading.depth === 3 ? "ml-3 text-[13px]" : ""}
                                        ${heading.depth > 3 ? "ml-6 text-xs" : ""}`}
                                        >
                                            {heading.text}
                                        </a>
                                    ))
                                ) : (
                                    <p class="text-sm text-gray-500 italic">
                                        No sections found.
                                    </p>
                                )
                            }
                        </nav>

                        <!-- Suggested Content -->
                        <div class="mt-10 pt-6 border-t border-gray-100">
                            <h3
                                class="text-xs font-bold text-gray-900 uppercase tracking-widest mb-4"
                            >
                                Suggested
                            </h3>
                            <ul class="space-y-3 text-sm">
                                <li>
                                    <a
                                        href="/resources"
                                        class="text-gray-600 hover:text-blue-600 transition-colors font-medium"
                                    >
                                        Back to Resources Explorer
                                    </a>
                                </li>
                                <li>
                                    <a
                                        href="/about"
                                        class="text-gray-600 hover:text-blue-600 transition-colors font-medium"
                                    >
                                        About SITE Organization
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </div>
                </aside>
            </div>
        </div>
    </div>
</MainLayout>

<style is:global>
    /* Styling for the light documentation prose (like GitLab docs) */
    .custom-light-prose {
        font-family: inherit;
    }
    .custom-light-prose a {
        color: #1f75cb;
        text-decoration: none;
        word-wrap: break-word;
    }
    .custom-light-prose a:hover {
        text-decoration: underline;
    }
    .custom-light-prose h2 {
        color: #1f1e24;
        font-weight: 700;
        font-size: 1.75rem;
        margin-top: 2.5em;
        margin-bottom: 0.75em;
        line-height: 1.3;
        letter-spacing: -0.01em;
    }
    .custom-light-prose h3 {
        color: #1f1e24;
        font-weight: 600;
        font-size: 1.25rem;
        margin-top: 2em;
        margin-bottom: 0.75em;
        letter-spacing: -0.01em;
    }
    .custom-light-prose p {
        margin-bottom: 1.25em;
        line-height: 1.6;
        color: #333238;
    }
    .custom-light-prose ul {
        margin-top: 1em;
        margin-bottom: 1em;
        padding-left: 1.25em;
        list-style: disc;
    }
    .custom-light-prose ul li {
        margin-bottom: 0.5em;
        color: #333238;
    }
    .custom-light-prose ol {
        margin-top: 1em;
        margin-bottom: 1em;
        padding-left: 1.25em;
    }
    .custom-light-prose ol li {
        margin-bottom: 0.5em;
        color: #333238;
    }
    .custom-light-prose blockquote {
        border-left: 3px solid #1f75cb;
        background-color: #fbfcff;
        padding: 1rem 1.25rem;
        color: #333238;
        margin-top: 1.5em;
        margin-bottom: 1.5em;
        font-size: 0.95em;
    }
    .custom-light-prose blockquote p:last-child {
        margin-bottom: 0;
    }
    .custom-light-prose img {
        border-radius: 0.25rem;
        border: 1px solid #e5e7eb;
        margin-top: 2em;
        margin-bottom: 2em;
    }
    .custom-light-prose pre {
        background-color: #fbfafd !important; /* Fixed bad Tailwind CSS syntax */
        border: 1px solid #ececef;
        color: #333238;
        padding: 1rem;
        border-radius: 0.25rem;
        overflow-x: auto;
        margin-top: 1.5em;
        margin-bottom: 1.5em;
        font-size: 0.875em;
    }
    .custom-light-prose code {
        background-color: #fbfafd;
        padding: 0.15em 0.3em;
        border: 1px solid #ececef;
        border-radius: 0.25rem;
        font-size: 0.875em;
        color: #c93b3b;
        font-family:
            SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono",
            "Courier New", monospace;
    }
    .custom-light-prose pre code {
        background-color: transparent;
        border: none;
        color: inherit;
        padding: 0;
        font-size: 1em;
    }
</style>
