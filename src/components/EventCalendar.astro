---
import { getCollection } from "astro:content";

const allEvents = await getCollection("events");
const eventsData = allEvents.map((event) => ({
    id: event.slug,
    title: event.data.title,
    date: new Date(event.data.date).toISOString().split("T")[0], // YYYY-MM-DD
    time: event.data.time,
    location: event.data.location,
}));
---

<div
    class="bg-white rounded-xl shadow-sm border border-gray-200 mb-12 flex flex-col overflow-hidden max-w-5xl mx-auto aspect-square md:aspect-video min-h-[500px]"
>
    <!-- Calendar Header -->
    <div
        class="flex items-center justify-between px-6 py-4 border-b border-gray-200 bg-gray-50"
    >
        <h2 id="calendar-header" class="text-lg font-semibold text-gray-900">
            <!-- JavaScript will populate month and year here -->
        </h2>
        <div class="flex space-x-2">
            <button
                id="prev-month"
                class="p-2 rounded-md hover:bg-gray-200 transition-colors text-gray-600 focus:outline-none"
                aria-label="Previous month"
            >
                <svg
                    class="w-5 h-5"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M15 19l-7-7 7-7"></path>
                </svg>
            </button>
            <button
                id="next-month"
                class="p-2 rounded-md hover:bg-gray-200 transition-colors text-gray-600 focus:outline-none"
                aria-label="Next month"
            >
                <svg
                    class="w-5 h-5"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M9 5l7 7-7 7"></path>
                </svg>
            </button>
        </div>
    </div>

    <!-- Calendar Grid -->
    <div
        class="bg-gray-200 grid grid-cols-7 gap-px text-center text-xs font-semibold leading-6 text-gray-700"
    >
        <div class="bg-white py-2">Sun</div>
        <div class="bg-white py-2">Mon</div>
        <div class="bg-white py-2">Tue</div>
        <div class="bg-white py-2">Wed</div>
        <div class="bg-white py-2">Thu</div>
        <div class="bg-white py-2">Fri</div>
        <div class="bg-white py-2">Sat</div>
    </div>

    <div
        id="calendar-days"
        class="bg-gray-200 grid grid-cols-7 gap-px text-sm auto-rows-fr flex-grow"
    >
        <!-- JavaScript will populate days here -->
    </div>
</div>

<script define:vars={{ eventsData }}>
    document.addEventListener("DOMContentLoaded", () => {
        const header = document.getElementById("calendar-header");
        const daysContainer = document.getElementById("calendar-days");
        const prevBtn = document.getElementById("prev-month");
        const nextBtn = document.getElementById("next-month");

        let currentDate = new Date(); // Start with current date

        const renderCalendar = (date) => {
            const year = date.getFullYear();
            const month = date.getMonth(); // 0-indexed

            // Set Header Text
            const monthNames = [
                "January",
                "February",
                "March",
                "April",
                "May",
                "June",
                "July",
                "August",
                "September",
                "October",
                "November",
                "December",
            ];
            header.textContent = `${monthNames[month]} ${year}`;

            // Clear previous days
            daysContainer.innerHTML = "";

            // Get first day of the month and total days
            const firstDayIndex = new Date(year, month, 1).getDay();
            const lastDay = new Date(year, month + 1, 0).getDate();

            // Render padding for previous month's days
            for (let i = 0; i < firstDayIndex; i++) {
                const emptyCell = document.createElement("div");
                emptyCell.className = "bg-gray-50 p-2";
                daysContainer.appendChild(emptyCell);
            }

            // Render actual days
            const today = new Date();
            for (let i = 1; i <= lastDay; i++) {
                const cellDate = new Date(year, month, i);
                const cellDateString = cellDate.toISOString().split("T")[0];

                const isToday =
                    today.getDate() === i &&
                    today.getMonth() === month &&
                    today.getFullYear() === year;

                const dayCell = document.createElement("div");
                dayCell.className = `bg-white p-2 border-t-2 transition-colors overflow-hidden ${isToday ? "border-blue-500 bg-blue-50/30" : "border-transparent hover:bg-gray-50"}`;

                const dateHeader = document.createElement("div");
                dateHeader.className = `font-semibold text-sm mb-1 ${isToday ? "text-blue-600" : "text-gray-900"}`;
                dateHeader.textContent = i;
                dayCell.appendChild(dateHeader);

                // Filter events for this day
                const dayEvents = eventsData.filter(
                    (e) => e.date === cellDateString,
                );

                if (dayEvents.length > 0) {
                    const eventsList = document.createElement("div");
                    eventsList.className = "space-y-1 mt-1";

                    dayEvents.forEach((event) => {
                        const eventItem = document.createElement("a");
                        eventItem.href = "/events"; // Basic link to the events list below
                        eventItem.title = event.title;
                        eventItem.className =
                            "block px-2 py-1 text-xs font-medium bg-blue-100 text-blue-700 rounded truncate hover:bg-blue-200 transition-colors";
                        eventItem.textContent = event.title;
                        eventsList.appendChild(eventItem);
                    });

                    dayCell.appendChild(eventsList);
                }

                daysContainer.appendChild(dayCell);
            }

            // Fill remaining cells to complete the grid (always 42 cells total for 6 rows)
            const totalCells = firstDayIndex + lastDay;
            const remainingCells = 42 - totalCells;

            for (let i = 0; i < remainingCells; i++) {
                const emptyCell = document.createElement("div");
                emptyCell.className = "bg-gray-50 p-2";
                daysContainer.appendChild(emptyCell);
            }
        };

        // Event Listeners
        prevBtn.addEventListener("click", () => {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar(currentDate);
        });

        nextBtn.addEventListener("click", () => {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar(currentDate);
        });

        // Initial Render
        renderCalendar(currentDate);
    });
</script>
