---
import { getCollection } from "astro:content";

const allEvents = await getCollection("events");
const eventsData = allEvents.map((event) => ({
    id: event.id,
    title: event.data.title,
    date: new Date(event.data.date).toISOString().split("T")[0], // YYYY-MM-DD
    time: event.data.time,
    location: event.data.location,
}));
---

<div
    class="bg-white rounded-xl shadow-sm border border-gray-200 mb-12 flex flex-col overflow-hidden max-w-5xl mx-auto md:aspect-video min-h-[400px] sm:min-h-[500px]"
>
    <!-- Calendar Header -->
    <div
        class="flex items-center justify-between px-6 py-4 border-b border-gray-200 bg-gray-50"
    >
        <h2 id="calendar-header" class="text-lg font-semibold text-gray-900">
            <!-- JavaScript will populate month and year here -->
        </h2>
        <div class="flex space-x-2">
            <button
                id="prev-month"
                class="p-2 rounded-md hover:bg-gray-200 transition-colors text-gray-600 focus:outline-none"
                aria-label="Previous month"
            >
                <svg
                    class="w-5 h-5"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M15 19l-7-7 7-7"></path>
                </svg>
            </button>
            <button
                id="next-month"
                class="p-2 rounded-md hover:bg-gray-200 transition-colors text-gray-600 focus:outline-none"
                aria-label="Next month"
            >
                <svg
                    class="w-5 h-5"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M9 5l7 7-7 7"></path>
                </svg>
            </button>
        </div>
    </div>

    <!-- Calendar Grid -->
    <div
        class="bg-gray-200 grid grid-cols-7 gap-px text-center text-[10px] sm:text-xs font-semibold leading-6 text-gray-700"
    >
        <div class="bg-white py-2 sm:py-3 border-b border-gray-100">
            <span class="hidden sm:inline text-gray-400 font-medium">Sun</span
            ><span class="sm:hidden text-gray-400 font-medium">Su</span>
        </div>
        <div class="bg-white py-2 sm:py-3 border-b border-gray-100">
            <span class="hidden sm:inline text-gray-600 font-medium">Mon</span
            ><span class="sm:hidden text-gray-600 font-medium">Mo</span>
        </div>
        <div class="bg-white py-2 sm:py-3 border-b border-gray-100">
            <span class="hidden sm:inline text-gray-600 font-medium">Tue</span
            ><span class="sm:hidden text-gray-600 font-medium">Tu</span>
        </div>
        <div class="bg-white py-2 sm:py-3 border-b border-gray-100">
            <span class="hidden sm:inline text-gray-600 font-medium">Wed</span
            ><span class="sm:hidden text-gray-600 font-medium">We</span>
        </div>
        <div class="bg-white py-2 sm:py-3 border-b border-gray-100">
            <span class="hidden sm:inline text-gray-600 font-medium">Thu</span
            ><span class="sm:hidden text-gray-600 font-medium">Th</span>
        </div>
        <div class="bg-white py-2 sm:py-3 border-b border-gray-100">
            <span class="hidden sm:inline text-gray-600 font-medium">Fri</span
            ><span class="sm:hidden text-gray-600 font-medium">Fr</span>
        </div>
        <div class="bg-white py-2 sm:py-3 border-b border-gray-100">
            <span class="hidden sm:inline text-gray-400 font-medium">Sat</span
            ><span class="sm:hidden text-gray-400 font-medium">Sa</span>
        </div>
    </div>

    <div
        id="calendar-days"
        class="bg-gray-200 grid grid-cols-7 gap-px text-sm auto-rows-fr flex-grow"
    >
        <!-- JavaScript will populate days here -->
    </div>
</div>

<script define:vars={{ eventsData }}>
    document.addEventListener("DOMContentLoaded", () => {
        const header = document.getElementById("calendar-header");
        const daysContainer = document.getElementById("calendar-days");
        const prevBtn = document.getElementById("prev-month");
        const nextBtn = document.getElementById("next-month");

        let currentDate = new Date(); // Start with current date

        const renderCalendar = (date) => {
            const year = date.getFullYear();
            const month = date.getMonth(); // 0-indexed

            // Set Header Text
            const monthNames = [
                "January",
                "February",
                "March",
                "April",
                "May",
                "June",
                "July",
                "August",
                "September",
                "October",
                "November",
                "December",
            ];
            header.textContent = `${monthNames[month]} ${year}`;

            // Clear previous days
            daysContainer.innerHTML = "";

            // Get first day of the month and total days
            const firstDayIndex = new Date(year, month, 1).getDay();
            const lastDay = new Date(year, month + 1, 0).getDate();

            // Render padding for previous month's days
            const prevLastDay = new Date(year, month, 0).getDate();
            for (let i = firstDayIndex; i > 0; i--) {
                const prevCell = document.createElement("div");
                prevCell.className =
                    "bg-white p-1 md:p-2 overflow-hidden flex flex-col items-center opacity-75 h-full w-full";

                const dateHeader = document.createElement("div");
                dateHeader.className =
                    "shrink-0 flex items-center justify-center w-6 h-6 sm:w-8 sm:h-8 rounded-full font-semibold text-[10px] sm:text-sm mb-1 text-gray-400";
                dateHeader.textContent = prevLastDay - i + 1;
                prevCell.appendChild(dateHeader);

                const eventsContainer = document.createElement("div");
                eventsContainer.className = "flex-1 w-full overflow-hidden";
                prevCell.appendChild(eventsContainer);

                daysContainer.appendChild(prevCell);
            }

            // Render actual days
            const today = new Date();
            for (let i = 1; i <= lastDay; i++) {
                const cellDate = new Date(year, month, i);
                const cellDateString = cellDate.toISOString().split("T")[0];

                const isToday =
                    today.getDate() === i &&
                    today.getMonth() === month &&
                    today.getFullYear() === year;

                const dayEvents = eventsData.filter(
                    (e) => e.date === cellDateString,
                );

                const hasEvents = dayEvents.length > 0;

                const dayCell = document.createElement("div");
                dayCell.className = `bg-white p-1 md:p-2 flex flex-col items-center transition-colors overflow-visible hover:bg-gray-50 group cursor-pointer h-full w-full relative z-10`;

                const dateHeader = document.createElement("div");
                let headerClasses =
                    "shrink-0 flex items-center justify-center w-6 h-6 sm:w-8 sm:h-8 rounded-full font-medium text-[10px] sm:text-sm mb-1 transition-colors ";

                if (isToday) {
                    headerClasses +=
                        "bg-blue-600 text-white shadow-sm font-semibold";
                } else if (hasEvents) {
                    headerClasses +=
                        "bg-green-100/80 border border-green-200 text-green-700 shadow-sm font-bold group-hover:bg-green-200";
                } else {
                    headerClasses += "text-gray-900 group-hover:bg-gray-200";
                }
                dateHeader.className = headerClasses;
                dateHeader.textContent = i;
                dayCell.appendChild(dateHeader);

                if (hasEvents) {
                    // Create Tooltip for Hover
                    const tooltip = document.createElement("div");
                    tooltip.className =
                        "absolute bottom-full left-1/2 -translate-x-1/2 mb-1 hidden group-hover:flex flex-col items-center z-50 w-max max-w-[150px] pointer-events-none drop-shadow-md";

                    const tooltipContent = document.createElement("div");
                    tooltipContent.className =
                        "bg-gray-900 text-white text-[10px] sm:text-xs px-2 py-1.5 rounded text-center whitespace-normal pointer-events-auto leading-tight shadow-lg";

                    dayEvents.forEach((event, idx) => {
                        const eventLink = document.createElement("a");
                        eventLink.href = `/events/${event.id}/`;
                        eventLink.className =
                            "block hover:text-blue-300 transition-colors font-medium";
                        eventLink.textContent = event.title;

                        tooltipContent.appendChild(eventLink);

                        if (idx < dayEvents.length - 1) {
                            const separator = document.createElement("div");
                            separator.className =
                                "w-full h-px bg-gray-700 my-1";
                            tooltipContent.appendChild(separator);
                        }
                    });

                    const tooltipArrow = document.createElement("div");
                    tooltipArrow.className =
                        "w-0 h-0 border-l-[4px] border-r-[4px] border-t-[5px] border-l-transparent border-r-transparent border-t-gray-900 mt-[-1px]";

                    tooltip.appendChild(tooltipContent);
                    tooltip.appendChild(tooltipArrow);
                    dayCell.appendChild(tooltip);

                    // Add click handler to cell if there's only one event, to navigate quickly
                    if (dayEvents.length === 1) {
                        dayCell.addEventListener("click", () => {
                            window.location.href = `/events/${dayEvents[0].id}/`;
                        });
                    }
                }

                daysContainer.appendChild(dayCell);
            }

            // Fill remaining cells to complete the grid (always 42 cells total for 6 rows)
            const totalCells = firstDayIndex + lastDay;
            const remainingCells = 42 - totalCells;

            for (let i = 1; i <= remainingCells; i++) {
                const nextCell = document.createElement("div");
                nextCell.className =
                    "bg-white p-1 md:p-2 overflow-hidden flex flex-col items-center opacity-75 h-full w-full";

                const dateHeader = document.createElement("div");
                dateHeader.className =
                    "shrink-0 flex items-center justify-center w-6 h-6 sm:w-8 sm:h-8 rounded-full font-semibold text-[10px] sm:text-sm mb-1 text-gray-400";
                dateHeader.textContent = i;
                nextCell.appendChild(dateHeader);

                const eventsContainer = document.createElement("div");
                eventsContainer.className = "flex-1 w-full overflow-hidden";
                nextCell.appendChild(eventsContainer);

                daysContainer.appendChild(nextCell);
            }
        };

        // Event Listeners
        prevBtn.addEventListener("click", () => {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar(currentDate);
        });

        nextBtn.addEventListener("click", () => {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar(currentDate);
        });

        // Initial Render
        renderCalendar(currentDate);
    });
</script>
